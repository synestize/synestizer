<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <title>synestizer</title>

    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>

    <!-- synestizer style -->
    <link rel="stylesheet" href="css/style.css">

</head>

<body>

    <div id="wrapper">
        <section id="app">
            <canvas id="canvas"></canvas>

            <video id="video" muted autoplay></video>

            <h1 id="logo">SYNESTIZER BETA</h1>
            <div class="row full">
                <div id="info" class="large-12 large-centered columns text-center">
                    <h1 class="info-title">
                        Welcome to Synestizer.
                    </h1>
                    <p class="info-text">
                        Please enable your webcam in the browser and activate your loudspeakers.
                    </p>
                </div>
                <div id="rgb-panel" class="content active">
                    <div id="average-raw-bars" class="databars"></div>
                    <div id="covariance-raw-bars" class="databars"></div>
                    <div id="covariance-delta-bars" class="databars"></div>
                </div>
        </section>

        <!-- Footer -->
        <div id="footer">
            <div class="footer_content">
                &copy; 2015 by <a href="http://www.kasparkoenig.com/">kaspar</a>,
                <a href="https://www.livingthing.org">dan</a> &amp;
                <a href="http://www.stahlnow.com">stahl</a>.
                This work is licensed under a <a rel="license"
                href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
                Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
    <script src="./bower_components/pubsub.js/src/pubsub.js"></script>
    <script src="./bower_components/d3/d3.js"></script>
    <script src="./bower_components/zepto/zepto.js"></script>
    <script src="js/vendor/waax.js"></script>    
    
    <!-- our stuff -->
    <script src="./js/video/analyzer.js"></script>
    <script src="./js/video/videostats.js"></script>
    <script src="./js/media.js"></script>
    <script src="./js/video/mapping.js"></script>
    <script src="./js/audio/patches/minimal.js"></script>
    <script src="./js/audio/patches/triad.js"></script>
    <script src="./js/audio/synths/SP1.js"></script>
    <script src="./js/audio/synths/triad.js"></script>
    <script>
        "use strict";
        var analyzer;
        var pubsub;
        var averageRawHandle, averageDeltaHandle;
        var covarianceRawHandle, covarianceDeltaHandle;
        var barScale, colorScale;
        var averageRawDom, covarianceRawDom, covarianceDeltaDom, uiDom, logoDom;

        pubsub = PubSub; //give our global signal bus a nice name

        window.addEventListener('DOMContentLoaded', function() {
            // setup info div
            $("#info").removeClass("hide").addClass("show");
            
            media.getStream(
                function (stream) {
                    analyzer = new videoanalyzers.VideoAnalyzer({
                        vidElem: document.getElementById('video'),
                        canvElem: document.getElementById('canvas'),
                        statistics: [
                            new videostatistics.AverageColor(),
                            new videostatistics.Covariance()
                        ],
                        pubsub: pubsub,
                        stream: stream
                    });
                    $("#info").removeClass("show").addClass("hide");
                    $("#controls").removeClass("hide").addClass("show");
                }
            );

            averageRawDom = d3.select("#average-raw-bars");
            covarianceRawDom = d3.select("#covariance-raw-bars");
            covarianceDeltaDom = d3.select("#covariance-delta-bars");
            logoDom = d3.select("#logo");
            uiDom = d3.selectAll(".content.active");
            barScale = d3.scale.linear().domain([0, 1]).range([0, 300]);
            colorScale = d3.scale.linear().domain([0, 1]).rangeRound([0, 255]);
            averageRawHandle = pubsub.subscribe(
                "/videoanalyzer/averagecolor/raw", function(data){
                    var paramColor, bars;
                    // draw param bars
                    bars = averageRawDom.selectAll("div").data(data);
                    bars.enter().append("div");
                    bars.style("width", function(d) {
                        return barScale(d) + "px"; });
                    bars.style("background-color", function(d, i) {
                        if (i == 0)
                            return d3.rgb(255,0,0);
                        if (i == 1)
                            return d3.rgb(0,255,0);
                        if (i == 2)
                            return d3.rgb(0,0,255);
                    });
                    bars.exit().remove();
                    
                    paramColor = d3.rgb(
                        colorScale(data[0]),
                        colorScale(data[1]),
                        colorScale(data[2])
                    );
                    // change color of logo and ui
                    logoDom.style("color", paramColor);
                    uiDom.style("color", paramColor);
            });
        });
        covarianceRawHandle = pubsub.subscribe(
            "/videoanalyzer/covariance/raw", function(data){
                var paramColor, bars;
                // draw param bars
                bars = covarianceRawDom.selectAll("div").data(data);
                bars.enter().append("div");
                bars.style("width", function(d) {
                    return barScale(d) + "px"; });
                bars.exit().remove();
        });
        covarianceDeltaHandle = pubsub.subscribe(
            "/videoanalyzer/covariance/delta", function(data){
                var paramColor, bars;
                // draw param bars
                bars = covarianceDeltaDom.selectAll("div").data(data);
                bars.enter().append("div");
                bars.style("width", function(d) {
                    return barScale(d) + "px"; });
                bars.exit().remove();
        });
    </script>
</body>
</html>