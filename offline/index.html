<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <title>synestizer</title>

    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>

    <!-- foundation style -->
    <link rel="stylesheet" href="./bower_components/foundation/css/foundation.css">

    <!-- synestizer style -->
    <link rel="stylesheet" href="./css/style.css">

</head>

<body>

    <div id="wrapper">

        <!-- Footer -->
        <div id="footer">
            <div class="footer_content">
                &copy; 2015 by <a href="http://www.kasparkoenig.com/">kaspar</a>,
                <a href="https://www.livingthing.org">dan</a> &amp;
                <a href="http://www.stahlnow.com">stahl</a>.
                This work is licensed under a <a rel="license"
                href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
                Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
    <!-- foundation js -->
    <script src="./bower_components/jquery/dist/jquery.js"></script>
    <script src="./bower_components/foundation/js/foundation.min.js"></script>
    <script src="./bower_components/foundation/js/foundation/foundation.accordion.js"></script>
    <script>
        // init foundation
        $(document).foundation({
            accordion: {
                // specify the class used for accordion panels
                content_class: 'content',
                // specify the class used for active (or open) accordion panels
                active_class: 'active',
                // allow multiple accordion panels to be active at the same time
                multi_expand: true,
                // allow accordion panels to be closed by clicking on their headers
                // setting to false only closes accordion panels when another is opened
                toggleable: true
            }
        });

        // Set max-height the first time
        $(document).ready(function() {
            $('.reveal-modal').css('max-height', $('html').height() - 10 + 'px'); // 100 +10px to keep modal effect visible
        });

        // Reset max-height after window resize
        $(window).resize(function() {
            $('.reveal-modal').css('max-height', $('html').height() - 10 + 'px');
        });

        // sticky footer
        $(window).bind("load", function () {
            var footer = $("#footer");
            var pos = footer.position();
            var height = $(window).height();
            height = height - pos.top;
            height = height - footer.height();
            if (height > 0) {
                footer.animate({
                    'margin-top': height + 'px'
                });
            }
        });
    </script>
    <!-- ACTIVATE GOOGLE SPYWARE -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-59122990-1', 'auto');
        ga('send', 'pageview');
    </script>


    <!-- include backbone.js -->
    <script src="./bower_components/underscore/underscore-min.js"></script>
    <script src="./bower_components/backbone/backbone.js"></script>

    <!-- include WAAX -->
    <script src="./js/vendor/waax.js"></script>

    <!-- web components -->
    <script src="./bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="./bower_components/polymer/polymer.html">

    <link rel="import" href="./webcomponents/controls.html">

    <script src="./bower_components/pubsub.js/src/pubsub.js"></script>
    <script src="./bower_components/d3/d3.min.js"></script>

    <!-- video analysis -->
    <script src="./js/media.js"></script>
    <script src="./js/video/analyzer.js"></script>
    <script src="./js/video/mapping.js"></script>
    <script src="./js/video/videostats.js"></script>

    <!-- synths -->
    <script src="./js/audio/patches/minimal.js"></script>
    <script src="./js/audio/patches/triad.js"></script>
    <script src="./js/audio/synths/SP1.js"></script>
    <script src="./js/audio/synths/triad.js"></script>

    <!-- audio helper -->
    <script src="./js/audio/helpers/recorder.js"></script>

    <!-- preset saving/loading -->
    <script src="./js/presets.js"></script>
    <script src="./js/app.js"></script>

    <script>
        "use strict";
        
        var analyzer;
        var pubsub;
        var averageRawHandle, averageDeltaHandle;
        var covarianceRawHandle, covarianceDeltaHandle;
        var barScale, colorScale;
        var averageRawDom, covarianceRawDom, covarianceDeltaDom, uiDom, logoDom;
        var handle, bars, scale, average, stream;

        pubsub = PubSub; //give our global signal bus a nice name

        $( document ).ready( function() {
            // setup info div
            $("#info").removeClass("hide").addClass("show");
            media.getStream(
                function (stream) {
                analyzer = new window.videoanalyzers.VideoAnalyzer({
                    vidElem: document.getElementById('video'),
                    canvElem: document.getElementById('canvas'),
                    statistics: [new window.videostatistics.AverageColor()],
                    pubsub: pubsub,
                    stream: stream
                });
                $("#info").removeClass("show").addClass("hide");
                $("#controls").removeClass("hide").addClass("show");

                // call resize for video resizing
                resize();

                // start the app
                new app.AppView();
            });
            
            averageRawDom = d3.select("#average-raw-bars");
            covarianceRawDom = d3.select("#covariance-raw-bars");
            covarianceDeltaDom = d3.select("#covariance-delta-bars");
            logoDom = d3.select("#logo");
            uiDom = d3.selectAll(".content.active");
            barScale = d3.scale.linear().domain([0, 1]).range([0, 300]);
            colorScale = d3.scale.linear().domain([0, 1]).rangeRound([0, 255]);
            averageRawHandle = pubsub.subscribe(
                "/videoanalyzer/averagecolor/raw",
                function(data){
                    var paramColor, bars;
                    // draw param bars
                    bars = averageRawDom.selectAll("div").data(data);
                    bars.enter().append("div");
                    bars.style("width", function(d) {
                        return barScale(d) + "px"; });
                    bars.style("background-color", function(d, i) {
                        if (i == 0)
                            return d3.rgb(255,0,0);
                        if (i == 1)
                            return d3.rgb(0,255,0);
                        if (i == 2)
                            return d3.rgb(0,0,255);
                    });
                    bars.exit().remove();
                    
                    paramColor = d3.rgb(
                        colorScale(data[0]),
                        colorScale(data[1]),
                        colorScale(data[2])
                    );
                    // change color of logo and ui
                    logoDom.style("color", paramColor);
                    uiDom.style("color", paramColor);
                }
            );
            covarianceRawHandle = pubsub.subscribe(
                "/videoanalyzer/covariance/raw", function(data){
                    var paramColor, bars;
                    // draw param bars
                    bars = covarianceRawDom.selectAll("div").data(data);
                    bars.enter().append("div");
                    bars.style("width", function(d) {
                        return barScale(d) + "px"; });
                    bars.exit().remove();
                }
            );
            covarianceDeltaHandle = pubsub.subscribe(
                "/videoanalyzer/covariance/delta", function(data){
                    var paramColor, bars;
                    // draw param bars
                    bars = covarianceDeltaDom.selectAll("div").data(data);
                    bars.enter().append("div");
                    bars.style("width", function(d) {
                        return barScale(d) + "px"; });
                    bars.exit().remove();
                }
            );

            $(window).resize(function() {
                resize();
            });

            function resize() {
                console.log("resize");
                // adapt video size to display
                var vw = $(window).width();
                var vh = $(window).height();

                var iw = 640;
                var ih = 480; // TODO

                if (iw / ih < vw / vh) {
                    var d1 = 100 * ((ih * (vw / iw)) / vh);
                    $("#video").css("height", d1+"%");
                    $("#video").css("width", "100%");
                    $("#video").css("top", (100-d1)/2+"%");
                } else {
                    var d2 = 100 * ((iw * (vh / ih)) / vw);
                    $("#video").css("height", "100%");
                    $("#video").css("width", d2+"%");
                    $("#video").css("left", (100-d2)/2+"%");
                }
            };
        });
    </script>

</body>
</html>