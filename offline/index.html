<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <title>synestizer</title>

    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>

    <!-- foundation style -->
    <link rel="stylesheet" href="./bower_components/foundation/css/foundation.css">

    <!-- synestizer style -->
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>

    <div id="wrapper">
      <section id="app">

          <canvas id="canvas"></canvas>

          <video id="video" muted autoplay></video>

          <h1 id="logo">SYNESTIZER BETA</h1>

          <div class="row full">

              <div id="info" class="large-12 large-centered columns hide text-center">
                  <h1 class="info-title">
                      Welcome to Synestizer.
                  </h1>

                  <p class="info-text">
                      Please enable your webcam in the browser and activate your loudspeakers.<br />
                      This app requires an updated version of <a href="http://www.google.com/chrome/">chrome</a> or <a href="http://www.opera.com">opera</a> browser.<br />
                      Firefox will be supported in the future.<br />
                      Safari/iOS is not supported.<br />
                      <a href="./faq.html">F.A.Q.</a>
                  </p>
              </div>


              <div id="controls" class="hide">
                  <div id="leftcontrolsidebar" class="sidebar large-3 small-3 medium-3 columns left">
                      <ul class="button-group" style="height: 45px; padding-left: 2px;">
                          <li><a href="#" id="fullscreen" class="button tiny fi-arrows-out"></a></li>
                          <li><a href="#" id="switchDevices" class="button tiny" title="Switch cam!"><i class="fi-video"></i></a></li>
                          <li><a href="./faq.html" class="button tiny"><i class="fi-info"></i></a></li>
                      </ul>

                      <a href="#" style="background-color: #f0f; padding: 5px; color: #fff;" data-dropdown="midiIn" data-options="is_hover:true; hover_timeout:5000"><span id="midiInDevice">MIDI Controller</span></a>

                      <ul id="midiIn" class="f-dropdown" data-dropdown-content></ul>

                      <dl class="accordion" data-accordion>
                          <dd class="accordion-navigation">
                              <a href="#analysis-panel">Analysis</a>
                              <div id="analysis-panel" class="content active"></div>
                          </dd>
                      </dl>
                  </div>

                  <div id="rightcontrolsidebar" class="sidebar large-3 medium-3 small-5 columns patchcontrols">
                  </div>
              </div>
          </div>
      </section>

        <!-- Footer -->
        <div id="footer">
            <div class="footer_content">
                &copy; 2015 by <a href="http://www.kasparkoenig.com/">kaspar</a>,
                <a href="https://www.livingthing.org">dan</a> &amp;
                <a href="http://www.stahlnow.com">stahl</a>.
                This work is licensed under a <a rel="license"
                href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
                Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>
        </div>
    </div>
    <!-- foundation js -->
    <script src="./bower_components/jquery/dist/jquery.js"></script>
    <script src="./bower_components/foundation/js/foundation.min.js"></script>
    <script src="./bower_components/foundation/js/foundation/foundation.accordion.js"></script>
    <script>
        // init foundation
        $(document).foundation({
            accordion: {
                // specify the class used for accordion panels
                content_class: 'content',
                // specify the class used for active (or open) accordion panels
                active_class: 'active',
                // allow multiple accordion panels to be active at the same time
                multi_expand: true,
                // allow accordion panels to be closed by clicking on their headers
                // setting to false only closes accordion panels when another is opened
                toggleable: true
            }
        });

        // Set max-height the first time
        $(document).ready(function() {
            $('.reveal-modal').css('max-height', $('html').height() - 10 + 'px'); // 100 +10px to keep modal effect visible
        });

        // Reset max-height after window resize
        $(window).resize(function() {
            $('.reveal-modal').css('max-height', $('html').height() - 10 + 'px');
        });

        // sticky footer
        $(window).bind("load", function () {
            var footer = $("#footer");
            var pos = footer.position();
            var height = $(window).height();
            height = height - pos.top;
            height = height - footer.height();
            if (height > 0) {
                footer.animate({
                    'margin-top': height + 'px'
                });
            }
        });
    </script>

    <!-- 3rd party utils -->
    <script src="./bower_components/underscore/underscore.js"></script>
    <script src="./bower_components/rxjs/dist/rx.all.js"></script>
    <script src="./bower_components/transducers-js/transducers.js"></script>
    <!-- <script src="./bower_components/Percussion/dist/Percussion.js"></script> -->
    <script src="./bower_components/d3/d3.js"></script>
    <!-- why not use Rx.internals.PriorityQueue? -->
    <script src="./js/vendor/heapqueue/heapqueue.js"></script>
    
    <!-- audio/video infrastructure -->
    <script src="./js/media.js"></script>

    <!-- video analysis -->
    <script src="./js/videoanalysis/_videoanalysis.js"></script>
    <script src="./js/videoanalysis/statistic.js"></script>
    <script src="./js/videoanalysis/visualizer.js"></script>

    <!-- audio infrastructure -->
    <script src="./js/vendor/WAAX/waax.js"></script>
    <script src="./js/vendor/WAAX/plugins.js"></script>
    <!-- <script src="./js/audio/lib/scaling.js"></script> -->
    <script src="./js/audio/synth/triadsynth.js"></script>

    <!-- audio models -->
    <script src="./js/audio/ensemble/_ensemble.js"></script>
    <script src="./js/audio/ensemble/triad_ens.js" ></script>

    <!-- audio/video patches -->
    <script src="./js/patch/_patch.js"></script>
    <!-- <script src="./js/patch/patches.js"></script> -->

    <script>
        "use strict";
        
        var patch;
        var videoPixels;
        
        $( document ).ready( function() {
            // setup info div
            $("#info").removeClass("hide").addClass("show");
            media.Media({
                success: function(mediaStream){
                    $("#info").removeClass("show").addClass("hide");
                    $("#controls").removeClass("hide").addClass("show");
                    // call resize for video resizing
                    resize();
                    media.attachMediaButton(
                        document.getElementById("switchDevices"));
                    media.attachFullscreenButton(
                        document.getElementById("fullscreen"));
                    videoPixels = media.VideoPixelPump(
                        document.getElementById("canvas"),
                        document.getElementById("video"),
                        mediaStream
                    );
                    patch = patch.basic_triad(
                        videoPixels,
                        document.getElementById("rightcontrolsidebar"),
                        document.getElementById("analysis-panel")
                    );
                }
            });

            $(window).resize(function() {
                resize();
            });

            function resize() {
                console.log("resize");
                // adapt video size to display
                var vw = $(window).width();
                var vh = $(window).height();

                var iw = 640;
                var ih = 480; // TODO

                if (iw / ih < vw / vh) {
                    var d1 = 100 * ((ih * (vw / iw)) / vh);
                    $("#video").css("height", d1+"%");
                    $("#video").css("width", "100%");
                    $("#video").css("top", (100-d1)/2+"%");
                } else {
                    var d2 = 100 * ((iw * (vh / ih)) / vw);
                    $("#video").css("height", "100%");
                    $("#video").css("width", d2+"%");
                    $("#video").css("left", (100-d2)/2+"%");
                }
            };
        });
    </script>
    <script type="text/javascript">
        (function() {
            var loc = window.location;
            var pathname = loc.pathname;
            var basepathname = pathname.slice(0, pathname.lastIndexOf("/")+1);
            window.baseUrl = loc.protocol + "//" + loc.host + basepathname;
        })();
    </script>
    <!-- ACTIVATE GOOGLE SPYWARE -->
    <!-- Must be LAST -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-59122990-1', 'auto');
        ga('send', 'pageview');
    </script>

</body>
</html>