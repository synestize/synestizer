{% extends "base.html" %}
{% load staticfiles %}
{% load sekizai_tags %}
{% load compress %}
{% block main %}


<section id="app">

    <canvas id="canvas"></canvas>

    <video id="video" muted autoplay></video>

    <h1 id="logo">SYNESTIZER BETA</h1>

    <div class="row full">

        <div id="info" class="large-12 large-centered columns hide text-center">
            <h1 class="info-title">
                Welcome to Synestizer.
            </h1>

            <p class="info-text">
                Please enable your webcam in the browser and activate your loudspeakers.
            </p>
        </div>


        <div id="controls" class="hide">

            <div class="large-centered large-12 columns">
                <div id="patch">
                    <script id="patch_template" type="text/template">
                        <!--<div>Patch: <%= uuid %></div>-->
                    </script>
                </div>
            </div>
            <div class="sidebar large-3 small-3 medium-3 columns left">
                <dl class="accordion" data-accordion>
                    <dd class="accordion-navigation">
                        <a href="#rgb-panel">RGB</a>

                        <div id="rgb-panel" class="content active">
                            <button onclick="document.getElementById('wrapper').webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);">fullscreen</button>
                            <div id="average-bars"></div>
                        </div>
                    </dd>
                    <dd class="accordion-navigation">
                        <a href="#dominant-panel">Dominant Color</a>

                        <div id="dominant-panel" class="content">
                            <div id="dominant-bars"></div>
                        </div>
                    </dd>
                </dl>
            </div>


            <div class="sidebar large-3 medium-3 small-5 columns right">
                <!-- SYNTHS -->
                <dl class="accordion scrollable_accordion" data-accordion>
                    <dd class="accordion-navigation">

                        <a href="#triad">Triad</a>

                        <div id="triad" class="content">

                            <script id="triad_template" type="text/template">

                                <div class="row">
                                    <div class="small-3 medium-3 large-3 columns">
                                        <div class="knob_label">
                                            Output
                                        </div>
                                        <webaudio-knob id="triadOutputKnob" src="{% static 'img/knob.png' %}"
                                        sprites="100" tooltip="Output" value="<%= preset.output  %>"
                                        min="0" max="1" step="0.01"></webaudio-knob>
                                    </div>
                                </div>

                                <div class="row text-center">
                                    <div class="large-4 small-4 medium-4 columns">
                                        <div class="knob_label">
                                            Freq 1
                                        </div>
                                        <webaudio-knob id="triadFreq1Knob" src="{% static 'img/knob.png' %}"
                                        sprites="100" valuetip="0" value="<%= preset.oscFreq1 %>"
                                        min="<%= synth.oscFreq1Min %>" max="<%= synth.oscFreq1Max %>"
                                        step="1"></webaudio-knob>
                                        <input id="triadFreq1Numberbox" type="number" value="<%= preset.oscFreq1 %>" min="<%= synth.oscFreq1Min %>" max="<%= synth.oscFreq1Max %>" />
                                    </div>
                                    <div class="large-4 small-4 medium-4 columns">
                                        <div class="knob_label">
                                            Freq 2
                                        </div>
                                        <webaudio-knob id="triadFreq2Knob" src="{% static 'img/knob.png' %}"
                                        sprites="100" valuetip="0" value="<%= preset.oscFreq2 %>"
                                        min="<%= synth.oscFreq2Min %>" max="<%= synth.oscFreq2Max %>"
                                        step="1"></webaudio-knob>
                                        <input id="triadFreq2Numberbox" type="number" value="<%= preset.oscFreq2 %>" min="<%= synth.oscFreq2Min %>" max="<%= synth.oscFreq2Max %>" />
                                    </div>
                                    <div class="large-4 small-4 medium-4 columns">
                                        <div class="knob_label">
                                            Freq 3
                                        </div>
                                        <webaudio-knob id="triadFreq3Knob" src="{% static 'img/knob.png' %}"
                                        sprites="100" valuetip="0" value="<%= preset.oscFreq3 %>"
                                        min="<%= synth.oscFreq3Min %>" max="<%= synth.oscFreq3Max %>"
                                        step="1"></webaudio-knob>
                                        <input id="triadFreq3Numberbox" type="number" value="<%= preset.oscFreq3 %>" min="<%= synth.oscFreq3Min %>" max="<%= synth.oscFreq3Max %>" />
                                    </div>



                                </div>

                                <div class="row text-center">
                                    <div class="small-4 medium-4 columns">
                                        <ul class="button-group" style="padding-top: 10px; padding-bottom: 10px;">
                                            <li><a href="#" class="button tiny">1</a></li>
                                            <li><a href="#" class="button tiny">2</a></li>
                                            <li><a href="#" class="button tiny">3</a></li>
                                        </ul>
                                    </div>
                                    <div class="small-4 medium-4 columns">
                                        <ul class="button-group" style="padding-top: 10px; padding-bottom: 10px;">
                                            <li><a href="#" class="button tiny">1</a></li>
                                            <li><a href="#" class="button tiny">2</a></li>
                                            <li><a href="#" class="button tiny">3</a></li>
                                        </ul>
                                    </div>
                                    <div class="small-4 medium-4 columns">
                                        <ul class="button-group" style="padding-top: 10px; padding-bottom: 10px;">
                                            <li><a href="#" class="button tiny">1</a></li>
                                            <li><a href="#" class="button tiny">2</a></li>
                                            <li><a href="#" class="button tiny">3</a></li>
                                        </ul>
                                    </div>
                                </div>

                            </script>
                        </div>

                    </dd>

                    <dd class="accordion-navigation">
                        <a href="#minimal">Minimal</a>
                        <div id="minimal" class="content">
                            <script id="minimal_template" type="text/template">
                                <div class="row knob">
                                    <div class="small-3 medium-3 large-3 columns">
                                        <div class="knob_label">
                                            Output
                                        </div>
                                        <webaudio-knob id="minimalOutputKnob" src="{% static 'img/knob.png' %}"
                                        sprites="100" tooltip="Output" value="<%= preset.output  %>"
                                        min="0" max="1" step="0.01"></webaudio-knob>
                                    </div>
                                </div>
                                <div class="row knob">
                                    <div class="small-3 medium-3 large-3 columns">
                                        <div class="knob_label">
                                            Tempo
                                        </div>
                                        <webaudio-knob id="minimalTempoKnob" src="{% static 'img/knob.png' %}"
                                        sprites="100" tooltip="Tempo" value="<%= preset.tempo  %>"
                                        min="20" max="1000" step="1"></webaudio-knob>
                                    </div>
                                </div>
                            </script>
                        </div>

                    </dd>

                    <dd class="accordion-navigation">
                        <a href="#sampler">Sampler</a>
                        <div id="sampler" class="content active">
                            <script id="sampler_template" type="text/template">
                                <div class="row knob">
                                    <div class="small-3 medium-3 large-3 columns">
                                        <div class="knob_label">
                                            Output
                                        </div>
                                        <webaudio-knob id="samplerOutputKnob" src="{% static 'img/knob.png' %}"
                                        sprites="100" tooltip="Output" value="<%= preset.output  %>"
                                        min="0" max="1" step="0.01"></webaudio-knob>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="small-12 medium-12 large-12 columns">
                                        <canvas id="recorderSpectrum" width="250" height="150"></canvas>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="small-3 medium-3 large-3 columns">
                                        <button class="tiny red" id="toggleRecording">record</button>
                                    </div>
                                </div>

                            </script>
                        </div>
                    </dd>
                </dl>
            </div>
        </div>
    </div>

</section>

{% addtoblock "js" %}

{% compress js %}


<!-- vendor -->
<script src="{% static 'pubsub.js/src/pubsub.js' %}"></script>
<script src="{% static 'd3/d3.min.js' %}"></script>

<!-- video analysis -->
<script src="{% static 'js/media.js' %}"></script>
<script src="{% static 'js/video/analyzer.js' %}"></script>
<script src="{% static 'js/video/mapping.js' %}"></script>
<script src="{% static 'js/video/videostats.js' %}"></script>

<script>
    // setup info div
    $("#info").removeClass("hide").addClass("show");

    var analyzer, pubsub, handle, bars, scale, average, stream;

    pubsub = PubSub; //give our global signal bus a nice name

    window.addEventListener('DOMContentLoaded', function() {
        media.getStream(
            function (stream) {
                analyzer = new this.videoanalyzers.VideoAnalyzer({
                    vidElem: document.getElementById('video'),
                    canvElem: document.getElementById('canvas'),
                    statistics: [new this.videostatistics.AverageColor()],
                    pubsub: pubsub,
                    stream: stream
                });
                $("#info").removeClass("show").addClass("hide");
                $("#controls").removeClass("hide").addClass("show");
            }
        );

        average = d3.select("#average-bars");
        scale = d3.scale.linear().domain([0, 1]).range([0, 300]);
        handle = pubsub.subscribe(
            "/videoanalyzer/averagecolor/raw", function(data){

                // draw color bars
                bars = average.selectAll("div").data(data);
                bars.enter().append("div");
                bars.style("width", function(d) { return scale(d) + "px"; });
                bars.style("background-color", function(d, i) {
                    if (i == 0)
                        return d3.rgb(255,0,0);
                    if (i == 1)
                        return d3.rgb(0,255,0);
                    if (i == 2)
                        return d3.rgb(0,0,255);
                })
                bars.exit().remove();

                // change color of logo and ui
                document.getElementById("logo").style.color = 'rgb(' + [~~(data[0]*255),~~(data[1]*255),~~(data[2]*255)].join(',') + ')';

                var ui = document.getElementsByClassName("content active");
                [].forEach.call(ui, function (el) {
                    el.style.backgroundColor = 'rgb(' + [~~(data[0]*255),~~(data[1]*255),~~(data[2]*255)].join(',') + ')'
                });


            });
});

</script>

<!-- synths -->
<script src="{% static 'js/audio/synths/triad.js' %}"></script>
<script src="{% static 'js/audio/synths/SP1.js' %}"></script>

<!-- audio helper -->
<script src="{% static 'js/audio/helpers/recorder.js' %}"></script>

<!-- patches -->
<script src="{% static 'js/audio/patches/triad.js' %}"></script>
<script src="{% static 'js/audio/patches/minimal.js' %}"></script>
<script src="{% static 'js/audio/patches/sampler.js' %}"></script>

<script>
    ID = {{ object.id }};
</script>

<!-- main app -->
<script src="{% static 'js/app.js' %}"></script>

{% endcompress %}

{% endaddtoblock %}


{% endblock %}
